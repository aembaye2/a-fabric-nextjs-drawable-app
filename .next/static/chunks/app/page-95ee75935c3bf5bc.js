(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{4960:function(){},6759:function(){},6272:function(){},7450:function(t,e,s){Promise.resolve().then(s.bind(s,1298)),Promise.resolve().then(s.bind(s,1523)),Promise.resolve().then(s.bind(s,49))},1298:function(t,e,s){"use strict";s.r(e),s.d(e,{default:function(){return I}});var i=s(7437),o=s(2265),r=s(4603),n=s(1652),a=s.n(n),h=s(4475),c=s.n(h);let l="/img/undo.png",u=t=>{let{imgUrl:e,altText:s,invertX:o=!1,size:r,enabled:n,clickCallback:a}=t;return(0,i.jsx)("img",{src:e,className:`
    ${n?c().enabled:c().disabled} ${o?"":c().invertx}
    `,alt:s,title:s,height:`${r}px`,width:`${r}px`,onClick:a})};var d=t=>{let{topPosition:e,leftPosition:s,canUndo:o,canRedo:r,downloadCallback:n,undoCallback:a,redoCallback:h,resetCallback:c}=t;return(0,i.jsx)("div",{style:{position:"absolute",top:e+4,left:s,display:"flex",flexDirection:"column",gap:4,zIndex:20},children:[{imgUrl:"/img/download.png",altText:"download",invertX:!1,enabled:!0,clickCallback:n},{imgUrl:l,altText:"Undo",invertX:!0,enabled:o,clickCallback:o?a:()=>{}},{imgUrl:l,altText:"Redo",invertX:!1,enabled:r,clickCallback:r?h:()=>{}},{imgUrl:"/img/bin.png",altText:"Reset canvas & history",invertX:!1,enabled:!0,clickCallback:c}].map(t=>(0,i.jsx)(u,{imgUrl:t.imgUrl,altText:t.altText,invertX:t.invertX,size:24,enabled:t.enabled,clickCallback:t.clickCallback},t.altText))})},f=s(764),v=s.n(f);let g={shouldReloadCanvas:!1,forceSendToStreamlit:!1},w={shouldReloadCanvas:!0,forceSendToStreamlit:!1},b={shouldReloadCanvas:!1,forceSendToStreamlit:!0},m={shouldReloadCanvas:!0,forceSendToStreamlit:!0},k=(t,e)=>{switch(e.type){case"save":if(!e.state)throw Error("No action state to save");if(v()(t.currentState))return{history:{undoStack:[],redoStack:[]},action:{...g},initialState:e.state,currentState:e.state};if(a()(e.state,t.currentState))return{history:{...t.history},action:{...g},initialState:t.initialState,currentState:t.currentState};{let s=t.history.undoStack.length>=100;return{history:{undoStack:[...t.history.undoStack.slice(s?1:0),t.currentState],redoStack:[]},action:{...g},initialState:null==t.initialState?t.currentState:t.initialState,currentState:e.state}}case"undo":if(0===t.history.undoStack.length)return{history:{...t.history},action:{...g},initialState:t.initialState,currentState:t.currentState};{let e=t.history.undoStack[t.history.undoStack.length-1];return{history:{undoStack:t.history.undoStack.slice(0,-1),redoStack:[...t.history.redoStack,t.currentState]},action:{...w},initialState:t.initialState,currentState:e}}case"redo":if(!(t.history.redoStack.length>0))return{history:{...t.history},action:{...g},initialState:t.initialState,currentState:t.currentState};{let e=t.history.redoStack[t.history.redoStack.length-1];return{history:{undoStack:[...t.history.undoStack,t.currentState],redoStack:t.history.redoStack.slice(0,-1)},action:{...w},initialState:t.initialState,currentState:e}}case"reset":if(!e.state)throw Error("No action state to store in reset");return{history:{undoStack:[],redoStack:[]},action:{...m},initialState:e.state,currentState:e.state};case"forceSendToStreamlit":return{history:{...t.history},action:{...b},initialState:t.initialState,currentState:t.currentState};default:throw Error("TS should protect from this")}},p={history:{undoStack:[],redoStack:[]},action:{forceSendToStreamlit:!1,shouldReloadCanvas:!1},initialState:{},currentState:{}},_=(0,o.createContext)({}),C=t=>{let{children:e}=t,[s,r]=(0,o.useReducer)(k,p),n=(0,o.useCallback)(t=>{console.log("Saving state 1:",t),r({type:"save",state:t})},[r]),a=(0,o.useCallback)(()=>{console.log("Undoing last action 2"),r({type:"undo"})},[r]),h=(0,o.useCallback)(()=>{console.log("Redoing last action 3"),r({type:"redo"})},[r]),c=(0,o.useCallback)(()=>r({type:"forceSendToStreamlit"}),[r]),l=(0,o.useCallback)(t=>{console.log("Resetting state 4"),r({type:"reset",state:t})},[r]),u=s.history.undoStack.length>0,d=s.history.redoStack.length>0;return(0,i.jsx)(_.Provider,{value:{canvasState:s,saveState:n,undo:a,redo:h,canUndo:u,canRedo:d,forceStreamlitUpdate:c,resetState:l},children:e})},M=()=>(0,o.useContext)(_);class S{constructor(t){this._canvas=t}}var x=S;class y extends x{configureCanvas(t){let{strokeWidth:e,strokeColor:s}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject(t=>t.selectable=t.evented=!1),this.strokeWidth=e,this.strokeColor=s,this._canvas.on("mouse:down",t=>this.onMouseDown(t)),this._canvas.on("mouse:move",t=>this.onMouseMove(t)),this._canvas.on("mouse:up",t=>this.onMouseUp(t)),this._canvas.on("mouse:out",t=>this.onMouseOut(t)),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out")}}onMouseDown(t){let e=this._canvas,s=t.e.button;this.isMouseDown=!0;var i=e.getPointer(t.e),o=[i.x,i.y,i.x,i.y];this.currentLine=new r.fabric.Line(o,{strokeWidth:this.strokeWidth,fill:this.strokeColor,stroke:this.strokeColor,originX:"center",originY:"center",selectable:!1,evented:!1}),0===s&&e.add(this.singlearrow)}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas;var s,i=e.getPointer(t.e);this.currentLine.set({x2:i.x,y2:i.y}),this.singlearrow&&e.remove(this.singlearrow);let o=0,n=0,a=0;o=this.currentLine.y2;var h=Math.atan2(o-(n=this.currentLine.y1),this.currentLine.x2-this.currentLine.x1);this.endTriangle=new r.fabric.Triangle({left:i.x,top:i.y,originX:"center",originY:"center",strokeWidth:this.strokeWidth,stroke:this.strokeColor,fill:this.strokeColor,selectable:!1,evented:!1,width:5*this.strokeWidth,height:5*this.strokeWidth,angle:180/Math.PI*h+90}),this.singlearrow=new r.fabric.Group([this.currentLine,this.endTriangle],{selectable:!1,evented:!1}),this.singlearrow.toObject=(s=this.singlearrow.toObject,function(){return r.fabric.util.object.extend(s.call(this),{toolType:"SingleArrowHeadTool"})}),e.add(this.singlearrow),e.renderAll()}onMouseUp(t){this.isMouseDown=!1;let e=this._canvas;var s=this.singlearrow;e.remove(this.singlearrow),e.add(s),e.renderAll()}onMouseOut(t){this.isMouseDown=!1}constructor(...t){super(...t),this.isMouseDown=!1,this.strokeWidth=10,this.strokeColor="#ffffff",this.currentLine=new r.fabric.Line,this.startCircle=new r.fabric.Circle,this.singlearrow=new r.fabric.Group,this.endTriangle=new r.fabric.Triangle}}class D extends x{configureCanvas(t){let{strokeWidth:e,strokeColor:s}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject(t=>t.selectable=t.evented=!1),this.strokeWidth=e,this.strokeColor=s,this._canvas.on("mouse:down",t=>this.onMouseDown(t)),this._canvas.on("mouse:move",t=>this.onMouseMove(t)),this._canvas.on("mouse:up",t=>this.onMouseUp(t)),this._canvas.on("mouse:out",t=>this.onMouseOut(t)),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out")}}onMouseDown(t){let e=this._canvas,s=t.e.button;this.isMouseDown=!0;var i=e.getPointer(t.e),o=[i.x,i.y,i.x,i.y];this.currentLine=new r.fabric.Line(o,{strokeWidth:this.strokeWidth,fill:this.strokeColor,stroke:this.strokeColor,originX:"center",originY:"center",selectable:!1,evented:!1}),0===s&&e.add(this.doublearrow)}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas;var s=e.getPointer(t.e);this.currentLine.set({x2:s.x,y2:s.y}),this.currentLine.setCoords(),this.doublearrow&&e.remove(this.doublearrow);let i=0,o=0,n=0;i=this.currentLine.y2;var a=Math.atan2(i-(o=this.currentLine.y1),this.currentLine.x2-this.currentLine.x1);this.endTriangle=new r.fabric.Triangle({left:s.x,top:s.y,originX:"center",originY:"center",strokeWidth:this.strokeWidth,stroke:this.strokeColor,fill:this.strokeColor,selectable:!1,evented:!1,width:5*this.strokeWidth,height:5*this.strokeWidth,angle:180/Math.PI*a+90}),this.startTriangle=new r.fabric.Triangle({left:this.currentLine.x1,top:this.currentLine.y1,originX:"center",originY:"center",strokeWidth:this.strokeWidth,stroke:this.strokeColor,fill:this.strokeColor,selectable:!1,evented:!1,width:5*this.strokeWidth,height:5*this.strokeWidth,angle:180/Math.PI*a-90}),this.doublearrow=new r.fabric.Group([this.currentLine,this.startTriangle,this.endTriangle],{selectable:!1,evented:!1}),e.add(this.doublearrow),e.renderAll()}onMouseUp(t){this.isMouseDown=!1;let e=this._canvas;var s=this.doublearrow;e.remove(this.doublearrow),e.add(s),e.renderAll()}onMouseOut(t){this.isMouseDown=!1}constructor(...t){super(...t),this.isMouseDown=!1,this.strokeWidth=10,this.strokeColor="#ffffff",this.currentLine=new r.fabric.Line,this.startCircle=new r.fabric.Circle,this.doublearrow=new r.fabric.Group,this.startTriangle=new r.fabric.Triangle,this.endTriangle=new r.fabric.Triangle}}class L extends x{configureCanvas(t){let{strokeWidth:e,strokeColor:s,fillColor:i}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject(t=>t.selectable=t.evented=!1),this.strokeWidth=e,this.strokeColor=s,this.fillColor=i,this._minRadius=e,this._canvas.on("mouse:down",t=>this.onMouseDown(t)),this._canvas.on("mouse:move",t=>this.onMouseMove(t)),this._canvas.on("mouse:up",t=>this.onMouseUp(t)),this._canvas.on("mouse:out",t=>this.onMouseOut(t)),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out")}}onMouseDown(t){let e=this._canvas,s=t.e.button;this.isMouseDown=!0;let i=e.getPointer(t.e);this.currentStartX=i.x,this.currentStartY=i.y,this.currentCircle=new r.fabric.Circle({left:this.currentStartX,top:this.currentStartY,originX:"left",originY:"center",strokeWidth:this.strokeWidth,stroke:this.strokeColor,fill:this.fillColor,selectable:!1,evented:!1,radius:this._minRadius}),0===s&&e.add(this.currentCircle)}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas,s=e.getPointer(t.e),i=this.linearDistance({x:this.currentStartX,y:this.currentStartY},{x:s.x,y:s.y})/2;this.currentCircle.set({radius:Math.max(i,this._minRadius),angle:180*Math.atan2(s.y-this.currentStartY,s.x-this.currentStartX)/Math.PI}),this.currentCircle.setCoords(),e.renderAll()}onMouseUp(t){this.isMouseDown=!1}onMouseOut(t){this.isMouseDown=!1}constructor(...t){super(...t),this.isMouseDown=!1,this.fillColor="#ffffff",this.strokeWidth=10,this.strokeColor="#ffffff",this.currentCircle=new r.fabric.Circle,this.currentStartX=0,this.currentStartY=0,this._minRadius=10,this.linearDistance=(t,e)=>{let s=e.x-t.x,i=e.y-t.y;return Math.sqrt(s*s+i*i)}}}class W extends x{configureCanvas(t){let{strokeWidth:e,strokeColor:s,scaleFactors:i,canvasHeight:o,canvasWidth:r}=t;return this.scaleFactors=i,this.canvasHeight=o,this.canvasWidth=r,this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject(t=>t.selectable=t.evented=!1),this.strokeWidth=e,this.strokeColor=s,this._canvas.on("mouse:down",t=>this.onMouseDown(t)),this._canvas.on("mouse:move",t=>this.onMouseMove(t)),this._canvas.on("mouse:up",t=>this.onMouseUp(t)),this._canvas.on("mouse:out",()=>this.onMouseOut()),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out"),this.clearTemporaryObjects()}}onMouseDown(t){if(0===t.e.button){this.isMouseDown=!0;let e=this._canvas.getPointer(t.e);this.drawLinesAndCoordinates(e.x,e.y)}}onMouseMove(t){let e=this._canvas.getPointer(t.e);this.isMouseDown||this.drawTemporaryLinesAndCoordinates(e.x,e.y)}onMouseUp(t){0===t.e.button&&(this.isMouseDown=!1,this.clearTemporaryObjects())}onMouseOut(){this.clearTemporaryObjects()}drawLinesAndCoordinates(t,e){let s=this._canvas,i=this.strokeWidth,o="rgba(99, 99, 156, .75)",n=this.canvasHeight,a=this.canvasWidth;this.horizontalLine=new r.fabric.Line([this.scaleFactors[3],e,t,e],{stroke:o,strokeWidth:i,selectable:!1,evented:!1,strokeDashArray:[10,5]}),this.verticalLine=new r.fabric.Line([t,e,t,.85*n],{stroke:o,strokeWidth:i,selectable:!1,evented:!1,strokeDashArray:[10,5]}),this.coordinateCircle=new r.fabric.Circle({left:t,top:e,radius:5,fill:o,selectable:!1,evented:!1,originX:"center",originY:"center"});let h=(t-this.scaleFactors[3])/(a-this.scaleFactors[3]-this.scaleFactors[5])*this.scaleFactors[0],c=this.scaleFactors[1]-(e-this.scaleFactors[4])/(n-this.scaleFactors[4]-this.scaleFactors[2])*this.scaleFactors[1];this.coordinatesTextX=new r.fabric.Text(`${h.toFixed(0)}`,{left:t+.01*a,top:.8*n,fill:o,fontSize:14,selectable:!1,evented:!1}),this.coordinatesTextY=new r.fabric.Text(`${c.toFixed(0)}`,{left:.13*a,top:e-.035*n,fill:o,fontSize:14,selectable:!1,evented:!1}),this.coordinates_group=new r.fabric.Group([this.horizontalLine,this.verticalLine,this.coordinateCircle,this.coordinatesTextX,this.coordinatesTextY],{selectable:!1,evented:!1}),s.add(this.coordinates_group),s.renderAll()}drawTemporaryLinesAndCoordinates(t,e){let s=this._canvas,i=this.strokeWidth,o="rgba(51, 0, 20, 0.5)",n=this.canvasHeight,a=this.canvasWidth;this.clearTemporaryObjects(),this.tempHorizontalLine=new r.fabric.Line([.12*a,e,t,e],{stroke:o,strokeWidth:i,selectable:!1,evented:!1,strokeDashArray:[10,5]}),this.tempVerticalLine=new r.fabric.Line([t,e,t,.85*n],{stroke:o,strokeWidth:i,selectable:!1,evented:!1,strokeDashArray:[10,5]}),this.tempCoordinateCircle=new r.fabric.Circle({left:t,top:e,radius:5,fill:o,selectable:!1,evented:!1,originX:"center",originY:"center"});let h=(t-this.scaleFactors[3])/(a-this.scaleFactors[3]-this.scaleFactors[5])*this.scaleFactors[0],c=this.scaleFactors[1]-(e-this.scaleFactors[4])/(n-this.scaleFactors[4]-this.scaleFactors[2])*this.scaleFactors[1];this.tempCoordinatesText=new r.fabric.Text(`(${h.toFixed(0)}, ${c.toFixed(0)})`,{left:t+10,top:e+10,fill:o,fontSize:14,selectable:!1,evented:!1}),this.tempCoordinates_group=new r.fabric.Group([this.tempHorizontalLine,this.tempVerticalLine,this.tempCoordinateCircle,this.tempCoordinatesText],{selectable:!1,evented:!1}),s.add(this.tempCoordinates_group),s.renderAll()}clearTemporaryObjects(){let t=this._canvas;this.tempCoordinates_group&&t.remove(this.tempCoordinates_group)}constructor(...t){super(...t),this.isMouseDown=!1,this.strokeColor="#ffffff",this.strokeWidth=10,this.horizontalLine=null,this.verticalLine=null,this.coordinateCircle=null,this.coordinatesTextX=null,this.coordinatesTextY=null,this.tempHorizontalLine=null,this.tempVerticalLine=null,this.tempCoordinateCircle=null,this.tempCoordinatesText=null,this.coordinates_group=new r.fabric.Group,this.tempCoordinates_group=new r.fabric.Group,this.scaleFactors=[1,1,1,1,1,1],this.canvasWidth=1,this.canvasHeight=1}}var P=s(1980);class T extends x{configureCanvas(t){let{strokeWidth:e,strokeColor:s,fillColor:i}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject(t=>t.selectable=t.evented=!1),this.strokeWidth=e,this.strokeColor=s,this.fillColor=i,this._canvas.on("mouse:down",t=>this.onMouseDown(t)),this._canvas.on("mouse:move",t=>this.onMouseMove(t)),this._canvas.on("mouse:up",t=>this.onMouseUp(t)),this._canvas.on("mouse:out",t=>this.onMouseOut(t)),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out")}}onMouseDown(t){let e=this._canvas,s=t.e.button,i=!1;"M "===this._pathString&&(i=!0),this.isMouseDown=!0;var o=e.getPointer(t.e);this.points.push([o.x,o.y]),i&&0===s?(this.controlPoints.push([o.x,o.y]),this._pathString=this.generateCurvePathData(this.controlPoints),this.startCircle=new r.fabric.Circle({left:o.x,top:o.y,originX:"center",originY:"center",strokeWidth:this.strokeWidth,stroke:this.strokeColor,fill:this.strokeColor,selectable:!1,evented:!1,radius:this.strokeWidth}),e.add(this.startCircle),i=!1):(0===s&&(this.controlPoints.push([o.x,o.y]),this._pathString=this.generateCurvePathData(this.controlPoints)),2===s&&(this.controlPoints.push([o.x,o.y]),this._pathString=this.generateCurvePathData(this.controlPoints),e.remove(this.startCircle))),2===s&&(e.remove(this.tempCurve),this.finalCurve=new r.fabric.Path(this._pathString,{strokeWidth:this.strokeWidth,fill:"",stroke:this.strokeColor,selectable:!1,evented:!1}),0!==this.finalCurve.width&&0!==this.finalCurve.height&&e.add(this.finalCurve),this._pathString="M ",this.controlPoints=[],this.points=[])}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas;var s=e.getPointer(t.e);this.points.push([s.x,s.y]);var i=this.generateCurvePathData(this.points);e.remove(this.tempCurve),this.tempCurve=new r.fabric.Path(i,{strokeWidth:this.strokeWidth,fill:"",stroke:this.strokeColor,selectable:!1,evented:!1}),e.add(this.tempCurve),this.points.pop()}onMouseUp(t){this.isMouseDown=!0}onMouseOut(t){this.isMouseDown=!1}generateCurvePathData(t){return P.jvg().curve(P.zgE.alpha(.5))(t)}constructor(...t){super(...t),this.isMouseDown=!1,this.fillColor="#ffffff00",this.strokeWidth=10,this.strokeColor="#ffffff",this.startCircle=new r.fabric.Circle,this.curvePath=new r.fabric.Path,this.tempCurvePath=new r.fabric.Path,this.controlPoints=[],this.points=[],this.tempCurve=new r.fabric.Path,this.finalCurve=new r.fabric.Path,this._pathString="M "}}class j extends x{configureCanvas(t){let{strokeWidth:e,strokeColor:s}=t;return this._canvas.isDrawingMode=!0,this._canvas.freeDrawingBrush.width=e,this._canvas.freeDrawingBrush.color=s,()=>{}}}class O extends x{configureCanvas(t){let{strokeWidth:e,strokeColor:s}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject(t=>t.selectable=t.evented=!1),this.strokeWidth=e,this.strokeColor=s,this._canvas.on("mouse:down",t=>this.onMouseDown(t)),this._canvas.on("mouse:move",t=>this.onMouseMove(t)),this._canvas.on("mouse:up",t=>this.onMouseUp(t)),this._canvas.on("mouse:out",t=>this.onMouseOut(t)),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out")}}onMouseDown(t){console.log("MouseDown on lineTool selection detected");let e=this._canvas,s=t.e.button;this.isMouseDown=!0;var i=e.getPointer(t.e),o=[i.x,i.y,i.x,i.y];this.currentLine=new r.fabric.Line(o,{strokeWidth:this.strokeWidth,fill:this.strokeColor,stroke:this.strokeColor,originX:"center",originY:"center",selectable:!1,evented:!1}),0===s&&e.add(this.currentLine)}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas;var s=e.getPointer(t.e);this.currentLine.set({x2:s.x,y2:s.y}),this.currentLine.setCoords(),e.renderAll()}onMouseUp(t){this.isMouseDown=!1;let e=this._canvas;0===this.currentLine.width&&0===this.currentLine.height&&e.remove(this.currentLine)}onMouseOut(t){this.isMouseDown=!1}constructor(...t){super(...t),this.isMouseDown=!1,this.strokeWidth=10,this.strokeColor="#ffffff",this.currentLine=new r.fabric.Line}}class X extends x{configureCanvas(t){let{strokeWidth:e,strokeColor:s,fillColor:i,displayRadius:o}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject(t=>t.selectable=t.evented=!1),this.strokeWidth=e,this.strokeColor=s,this.fillColor=i,this.displayRadius=o,this._canvas.on("mouse:down",t=>this.onMouseDown(t)),this._canvas.on("mouse:move",t=>this.onMouseMove(t)),this._canvas.on("mouse:up",t=>this.onMouseUp(t)),this._canvas.on("mouse:out",t=>this.onMouseOut(t)),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out")}}onMouseDown(t){let e=this._canvas,s=t.e.button;this.isMouseDown=!0;let i=e.getPointer(t.e);this.currentStartX=i.x-(this.displayRadius+this.strokeWidth/2),this.currentStartY=i.y,this.currentCircle=new r.fabric.Circle({left:this.currentStartX,top:this.currentStartY,originX:"left",originY:"center",strokeWidth:this.strokeWidth,stroke:this.strokeColor,fill:this.fillColor,selectable:!1,evented:!1,radius:this.displayRadius}),0===s&&e.add(this.currentCircle)}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas;this.currentCircle.setCoords(),e.renderAll()}onMouseUp(t){this.isMouseDown=!1}onMouseOut(t){this.isMouseDown=!1}constructor(...t){super(...t),this.isMouseDown=!1,this.fillColor="#ffffff",this.strokeWidth=10,this.strokeColor="#ffffff",this.currentCircle=new r.fabric.Circle,this.currentStartX=0,this.currentStartY=0,this.displayRadius=1}}class R extends x{configureCanvas(t){let{strokeWidth:e,strokeColor:s,fillColor:i}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject(t=>t.selectable=t.evented=!1),this.strokeWidth=e,this.strokeColor=s,this.fillColor=i,this._canvas.on("mouse:down",t=>this.onMouseDown(t)),this._canvas.on("mouse:move",t=>this.onMouseMove(t)),this._canvas.on("mouse:up",t=>this.onMouseUp(t)),this._canvas.on("mouse:out",t=>this.onMouseOut(t)),this._canvas.on("mouse:dblclick",t=>this.onMouseDoubleClick(t)),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out"),this._canvas.off("mouse:dblclick")}}onMouseDown(t){let e=this._canvas,s=t.e.button,i=!1;"M "===this._pathString&&(i=!0),this.isMouseDown=!0;var o=e.getPointer(t.e),n=[o.x,o.y,o.x,o.y];e.remove(this.currentLine),this.currentLine=new r.fabric.Line(n,{strokeWidth:this.strokeWidth,fill:this.strokeColor,stroke:this.strokeColor,originX:"center",originY:"center",selectable:!1,evented:!1}),0===s&&e.add(this.currentLine),i&&0===s?(this._pathString+=`${o.x} ${o.y} `,this.startCircle=new r.fabric.Circle({left:o.x,top:o.y,originX:"center",originY:"center",strokeWidth:this.strokeWidth,stroke:this.strokeColor,fill:this.strokeColor,selectable:!1,evented:!1,radius:this.strokeWidth}),e.add(this.startCircle),i=!1):(e.remove(this.currentPath),0===s&&(this._pathString+=`L ${o.x} ${o.y} `),2===s&&(this._pathString+="z",e.remove(this.startCircle))),this.currentPath=new r.fabric.Path(this._pathString,{strokeWidth:this.strokeWidth,fill:this.fillColor,stroke:this.strokeColor,originX:"center",originY:"center",selectable:!1,evented:!1}),0!==this.currentPath.width&&0!==this.currentPath.height&&e.add(this.currentPath),2===s&&(this._pathString="M ")}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas;var s=e.getPointer(t.e);this.currentLine.set({x2:s.x,y2:s.y}),this.currentLine.setCoords(),e.renderAll()}onMouseUp(t){this.isMouseDown=!0}onMouseOut(t){this.isMouseDown=!1}onMouseDoubleClick(t){let e=this._canvas;for(let t=0;t<3;t++){let t=this._pathString.lastIndexOf("L");-1===t?(this._pathString="M ",e.remove(this.startCircle)):this._pathString=this._pathString.slice(0,t)}e.remove(this.currentLine),e.remove(this.currentPath),this.currentPath=new r.fabric.Path(this._pathString,{strokeWidth:this.strokeWidth,fill:this.fillColor,stroke:this.strokeColor,originX:"center",originY:"center",selectable:!1,evented:!1}),e.add(this.currentPath)}constructor(...t){super(...t),this.isMouseDown=!1,this.fillColor="#ffffff",this.strokeWidth=10,this.strokeColor="#ffffff",this.startCircle=new r.fabric.Circle,this.currentLine=new r.fabric.Line,this.currentPath=new r.fabric.Path,this._pathString="M "}}class Y extends x{configureCanvas(t){let{strokeWidth:e,strokeColor:s,fillColor:i}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject(t=>t.selectable=t.evented=!1),this.strokeWidth=e,this.strokeColor=s,this.fillColor=i,this._minLength=e,this._canvas.on("mouse:down",t=>this.onMouseDown(t)),this._canvas.on("mouse:move",t=>this.onMouseMove(t)),this._canvas.on("mouse:up",t=>this.onMouseUp(t)),this._canvas.on("mouse:out",t=>this.onMouseOut(t)),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out")}}onMouseDown(t){let e=this._canvas,s=t.e.button;this.isMouseDown=!0;let i=e.getPointer(t.e);this.currentStartX=i.x,this.currentStartY=i.y,this.currentRect=new r.fabric.Rect({left:this.currentStartX,top:this.currentStartY,originX:"left",originY:"top",width:this._minLength,height:this._minLength,stroke:this.strokeColor,strokeWidth:this.strokeWidth,fill:this.fillColor,transparentCorners:!1,selectable:!1,evented:!1,strokeUniform:!0,noScaleCache:!1,angle:0}),0===s&&e.add(this.currentRect)}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas,s=e.getPointer(t.e);this.currentStartX>s.x&&this.currentRect.set({left:Math.abs(s.x)}),this.currentStartY>s.y&&this.currentRect.set({top:Math.abs(s.y)});let i=Math.abs(this.currentStartX-s.x),o=Math.abs(this.currentStartY-s.y);this.currentRect.set({width:Math.max(i,2*this._minLength),height:Math.max(o,2*this._minLength)}),this.currentRect.setCoords(),e.renderAll()}onMouseUp(t){this.isMouseDown=!1}onMouseOut(t){this.isMouseDown=!1}constructor(...t){super(...t),this.isMouseDown=!1,this.fillColor="#ffffff",this.strokeWidth=10,this.strokeColor="#ffffff",this.currentRect=new r.fabric.Rect,this.currentStartX=0,this.currentStartY=0,this._minLength=10}}class F extends x{configureCanvas(t){let{}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject(t=>t.selectable=t.evented=!1),this._canvas.on("mouse:down",t=>this.onMouseDown(t)),()=>{this._canvas.off("mouse:down")}}onMouseDown(t){let e=this._canvas,s=t.e.button;var i=e.getPointer(t.e);if(0===s){let t=prompt("Enter text:");if(t){let s=new r.fabric.IText(t,{left:i.x,top:i.y,fontSize:25,selectable:!1,evented:!1});e.add(s)}}}}class E extends x{configureCanvas(t){let e=this._canvas;e.isDrawingMode=!1,e.selection=!0,e.forEachObject(t=>t.selectable=t.evented=!0);let s=()=>{e.remove(e.getActiveObject())};return e.on("mouse:dblclick",s),()=>{e.off("mouse:dblclick",s)}}}let U={circle:L,curve:T,coordinate:W,text:F,freedraw:j,line:O,polygon:R,rect:Y,singlearrowhead:y,doublearrowhead:D,transform:E,point:X};var A=t=>{let{fillColor:e,strokeWidth:s,strokeColor:n,backgroundColor:h,backgroundImageURL:c,canvasWidth:l,canvasHeight:u,drawingMode:f,initialDrawing:v,displayToolbar:g,displayRadius:w,scaleFactors:b}=t,m=(0,o.useRef)(null),k=(0,o.useRef)(null),p=(0,o.useRef)(null),_=(0,o.useRef)(null),{canvasState:{action:{shouldReloadCanvas:C},currentState:S,initialState:x},saveState:y,undo:D,redo:L,canUndo:W,canRedo:P,resetState:T}=M();return(0,o.useEffect)(()=>{m.current&&(k.current=new r.fabric.Canvas(m.current,{enableRetinaScaling:!1})),p.current&&(_.current=new r.fabric.StaticCanvas(p.current,{enableRetinaScaling:!1}));let t=m.current;return t&&t.addEventListener("contextmenu",t=>{t.preventDefault()}),()=>{t&&t.removeEventListener("contextmenu",t=>{t.preventDefault()}),k.current?.dispose(),_.current?.dispose()}},[]),(0,o.useEffect)(()=>{k.current&&(k.current.clear(),a()(x,v)||k.current.loadFromJSON(v,()=>{k.current?.renderAll(),T(v)}))},[v,x,T]),(0,o.useEffect)(()=>{if(_.current&&c){let t=new Image;t.onload=function(){_.current?.getContext().drawImage(t,0,0)},t.src=c}},[c]),(0,o.useEffect)(()=>{k.current&&C&&k.current.loadFromJSON(S,()=>{k.current?.renderAll()})},[C,S]),(0,o.useEffect)(()=>{if(k.current){let t=new U[f](k.current).configureCanvas({fillColor:e,strokeWidth:s,strokeColor:n,displayRadius:w,scaleFactors:b,canvasHeight:u,canvasWidth:l}),i=()=>{y(k.current?.toJSON())};return k.current.on("mouse:up",i),k.current.on("mouse:dblclick",i),()=>{t(),k.current?.off("mouse:up",i),k.current?.off("mouse:dblclick",i)}}},[s,n,w,e,f,v,b,u,l,y]),(0,i.jsxs)("div",{style:{position:"relative"},children:[(0,i.jsx)("div",{style:{position:"absolute",top:0,left:0,zIndex:0,backgroundColor:"rgba(255, 0, 0, 0.1)"},children:(0,i.jsx)("canvas",{ref:p,width:l,height:u})}),(0,i.jsx)("div",{style:{position:"absolute",top:0,left:0,zIndex:10,border:"1px solid black"},children:(0,i.jsx)("canvas",{ref:m,width:l,height:u,className:"border border-lightgrey"})}),(0,i.jsx)("div",{style:{display:"flex",flexDirection:"row"},children:g&&(0,i.jsx)(d,{topPosition:0,leftPosition:l+5,downloadCallback:()=>{if(k.current){let t=k.current.toDataURL({format:"png",quality:1}),e=document.createElement("a");e.href=t,e.download="canvas.png",e.click()}},canUndo:W,canRedo:P,undoCallback:D,redoCallback:L,resetCallback:()=>{T(x)}})})]})},z=t=>{let{drawingMode:e,setDrawingMode:s}=t;return(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{htmlFor:"drawing-mode",children:"Drawing tools:"}),(0,i.jsx)("select",{id:"drawing-mode",value:e,onChange:t=>s(t.target.value),children:["point","line","polygon","rect","circle","freedraw","coordinate","curve","singlearrowhead","doublearrowhead","text","transform"].map(t=>(0,i.jsx)("option",{value:t,children:t},t))})]})},I=function(){let[t,e]=(0,o.useState)("point"),[s,r]=(0,o.useState)({});return(0,o.useEffect)(()=>{fetch("initial_drawing.json").then(t=>t.json()).then(t=>{t.objects&&t.objects.forEach(t=>{t.selectable=!1}),r(t)}).catch(t=>console.error("Error fetching initial drawing:",t))},[]),(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)("div",{children:[(0,i.jsx)("h1",{children:"Fabric.js Drawable Canas in Next.js"}),(0,i.jsx)(z,{drawingMode:t,setDrawingMode:e}),(0,i.jsx)(C,{children:(0,i.jsx)(A,{fillColor:"transparent",strokeWidth:3,strokeColor:"black",backgroundColor:"#ffffff",backgroundImageURL:"",canvasWidth:700,canvasHeight:500,drawingMode:t,initialDrawing:s,displayToolbar:!0,displayRadius:5,scaleFactors:[100,100,75,84,25,35]})})]})})}},4475:function(t){t.exports={enabled:"CanvasToolbar_enabled__nBIsV",disabled:"CanvasToolbar_disabled__rGI2V",invertx:"CanvasToolbar_invertx__YgXL8"}}},function(t){t.O(0,[857,789,275,971,117,744],function(){return t(t.s=7450)}),_N_E=t.O()}]);